<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    canvas {
      display: block;
      margin: 20px auto;
    }
    .controls {
      margin-top: 20px;
    }
    input[type="range"] {
      width: 90%;
      margin-right: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
    }
    #feedback {
      margin-top: 10px;
      font-size: 18px;
      color: green;
    }
    #averageDeviation {
      font-size: 18px;
      color: blue;
    }
    #recentDeviations {
      font-size: 16px;
      color: darkblue;
      text-align: left;
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid lightgray;
      padding: 5px;
      background-color: white;
    }
    .footer {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="400" height="530"></canvas>
  <div class="controls">
    <button id="newButton">New</button>
    <button id="confirmButton">Confirm</button>
    <span id="overlapValue">32/32</span>
    <span id="angleValue"></span>
    <br><br>
    <input type="range" id="overlapSlider" min="1" max="32" value="32" step="1">
    <div id="feedback"></div>
  </div>

  <div class="footer">
    <div id="averageDeviation">Average Deviation: 0.0</div>
    <div id="recentDeviations"></div>
  </div>

  <script>
    // Canvas setup
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Constants
    const DEFAULT_BALL_RADIUS = 60; // Default radius of the balls
    const CANVAS_WIDTH = canvas.width;
    const CANVAS_HEIGHT = canvas.height;

    let correctOverlap = Math.floor(Math.random() * 32) + 1; // Random value between 1 and 32
    let objectBallOnLeft = Math.random() < 0.5; // Randomly decide if the object ball is on the left or right
    let ballRadius = getRandomBallRadius(); // Randomize ball radius
    let ballDiameter = ballRadius * 2;
    let objectBallY = getRandomObjectBallY(); // Randomize object ball Y position
    let userChoices = []; // Array to store all user choices with their corresponding correctOverlap
    let showVerticalLine = false; // Flag to control whether to draw the vertical line

    function getRandomObjectBallY() {
      const minDistanceFromCueBallCenter = ballDiameter;
      const cueBallY = (CANVAS_HEIGHT * 3) / 4;
      const minY = Math.max(ballRadius, cueBallY - CANVAS_HEIGHT + minDistanceFromCueBallCenter);
      const maxY = Math.min(CANVAS_HEIGHT - ballRadius, cueBallY - minDistanceFromCueBallCenter);
      return Math.random() * (maxY - minY) + minY;
    }

    function getRandomBallRadius() {
      return Math.random() * (DEFAULT_BALL_RADIUS - (DEFAULT_BALL_RADIUS * 2 / 3)) + (DEFAULT_BALL_RADIUS * 2 / 3);
    }

    function drawScene(ghostBallX, ghostBallY, userChosenX) {
      ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

      // Calculate positions
      const cueBallX = CANVAS_WIDTH / 2;
      const cueBallY = (CANVAS_HEIGHT * 3) / 4;
      const horizontalDistance = ballDiameter * (1 - correctOverlap / 32);
      const objectBallX = objectBallOnLeft ? cueBallX - horizontalDistance : cueBallX + horizontalDistance;

      // Set stroke style and line width for consistency
      ctx.strokeStyle = 'black';
      ctx.lineWidth = 1;

      // Draw cue ball
      ctx.beginPath();
      ctx.arc(cueBallX, cueBallY, ballRadius, 0, Math.PI * 2);
      ctx.fillStyle = 'white';
      ctx.fill();
      ctx.stroke();

      // Draw object ball
      ctx.beginPath();
      ctx.arc(objectBallX, objectBallY, ballRadius, 0, Math.PI * 2);
      ctx.fillStyle = 'red';
      ctx.fill();
      ctx.stroke();

      // Draw cue line
      ctx.beginPath();
      ctx.moveTo(cueBallX, cueBallY + ballRadius);
      ctx.lineTo(cueBallX, cueBallY + ballRadius + 50);
      ctx.stroke();

      // Draw vertical dashed line at cue ball's x-coordinate if needed
      if (showVerticalLine) {
        ctx.setLineDash([5, 5]);
        ctx.strokeStyle = 'gray';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(cueBallX, 0);
        ctx.lineTo(cueBallX, CANVAS_HEIGHT);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      // Draw user chosen ball if provided coordinates
      if (userChosenX !== undefined) {
        drawUserChosenBall(userChosenX, objectBallY);
      }

      // Draw ghost ball if provided coordinates
      if (ghostBallX !== undefined && ghostBallY !== undefined) {
        drawGhostBall(ghostBallX, ghostBallY);
      }
    }

    function updateOverlapDisplay(value) {
      const actualValue = objectBallOnLeft ? 33 - value : value;
      document.getElementById('overlapValue').textContent = `${actualValue}/32`;
      const angle = Math.asin(1 - actualValue / 32) * (180 / Math.PI);
      document.getElementById('angleValue').textContent = ` (${angle.toFixed(1)}째)`;
    }

    function calculateAngleFromOverlap(overlap) {
      return Math.asin(1 - overlap / 32) * (180 / Math.PI);
    }

    function calculateAverageDeviation() {
      if (userChoices.length === 0) return 0;
      const recentChoices = userChoices.slice(-5); // Get the last 5 choices
      const totalDeviation = recentChoices.reduce((sum, choice) => sum + Math.abs(choice.choice - choice.correctOverlap), 0);
      return totalDeviation / recentChoices.length;
    }

    function updateRecentDeviations() {
      const deviationsDiv = document.getElementById('recentDeviations');
      const recentChoices = userChoices.slice(-5); // Get the last 5 choices
      const deviations = recentChoices.map(choice => `| Choice: ${choice.choice} | Correct: ${choice.correctOverlap} | Deviation: ${Math.abs(choice.choice - choice.correctOverlap)} |`);
      deviationsDiv.innerHTML = deviations.join('<br>');
    }

    function drawGhostBall(x, y) {
      // Set stroke style and line width for ghost ball
      ctx.setLineDash([5, 5]); // Dashed line
      ctx.strokeStyle = 'blue';
      ctx.lineWidth = 2;

      // Draw ghost ball
      ctx.beginPath();
      ctx.arc(x, y, ballRadius, 0, Math.PI * 2);
      ctx.stroke();

      // Reset line dash
      ctx.setLineDash([]);
    }

    function drawUserChosenBall(x, y) {
      // Set stroke style and line width for user chosen ball
      ctx.setLineDash([5, 5]); // Dashed line
      ctx.strokeStyle = 'green';
      ctx.lineWidth = 2;

      // Draw user chosen ball
      ctx.beginPath();
      ctx.arc(x, y, ballRadius, 0, Math.PI * 2);
      ctx.stroke();

      // Reset line dash
      ctx.setLineDash([]);
    }

    function checkAnswer(userChoice) {
      const feedbackDiv = document.getElementById('feedback');
      const actualChoice = objectBallOnLeft ? 33 - userChoice : userChoice;
      const correctAngle = calculateAngleFromOverlap(correctOverlap).toFixed(1);
      const chosenAngle = calculateAngleFromOverlap(actualChoice).toFixed(1);

      if (actualChoice === correctOverlap) {
        feedbackDiv.textContent = `Correct! The overlap is ${correctOverlap}/32 (${correctAngle}째).`;
        feedbackDiv.style.color = 'green';
      } else {
        feedbackDiv.textContent = `Incorrect! The correct overlap was ${correctOverlap}/32 (${correctAngle}째). You chose ${actualChoice}/32 (${chosenAngle}째).`;
        feedbackDiv.style.color = 'red';
      }

      // Store the user choice along with the current correctOverlap
      userChoices.push({ choice: actualChoice, correctOverlap: correctOverlap });

      // Calculate average deviation
      const averageDeviation = calculateAverageDeviation();
      document.getElementById('averageDeviation').textContent = `Average Deviation: ${averageDeviation.toFixed(1)}`;

      // Update recent deviations
      updateRecentDeviations();

      // Redraw the scene including the ghost ball and vertical line
      const cueBallX = CANVAS_WIDTH / 2;
      const cueBallY = (CANVAS_HEIGHT * 3) / 4;
      const horizontalDistance = ballDiameter * (1 - correctOverlap / 32);
      const objectBallX = objectBallOnLeft ? cueBallX - horizontalDistance : cueBallX + horizontalDistance;

      // Calculate ghost ball position
      const ghostBallX = cueBallX;
      const distanceBetweenCenters = ballDiameter;
      const deltaY = Math.sqrt(distanceBetweenCenters ** 2 - (objectBallX - ghostBallX) ** 2);
      const ghostBallY1 = objectBallY + deltaY;
      const ghostBallY2 = objectBallY - deltaY;

      // Choose the lower ghost ball Y coordinate
      const ghostBallY = Math.max(ghostBallY1, ghostBallY2);

      // Calculate user chosen ball position
      const userChosenHorizontalDistance = ballDiameter * (1 - actualChoice / 32);
      const userChosenX = objectBallOnLeft ? cueBallX - userChosenHorizontalDistance : cueBallX + userChosenHorizontalDistance;

      showVerticalLine = true; // Show the vertical line after confirming
      drawScene(ghostBallX, ghostBallY, userChosenX);
    }

    function newQuestion() {
      correctOverlap = Math.floor(Math.random() * 32) + 1; // Generate a new random correct overlap value
      objectBallOnLeft = Math.random() < 0.5; // Randomly decide if the object ball is on the left or right
      ballRadius = getRandomBallRadius(); // Randomize ball radius
      ballDiameter = ballRadius * 2;
      objectBallY = getRandomObjectBallY(); // Randomize object ball Y position
      const sliderValue = objectBallOnLeft ? 1 : 32; // Set slider value based on object ball position
      document.getElementById('overlapSlider').value = sliderValue; // Reset slider to default value
      updateOverlapDisplay(sliderValue); // Update displayed overlap value
      document.getElementById('feedback').textContent = ''; // Clear feedback message
      showVerticalLine = false; // Hide the vertical line when starting a new question
      drawScene(); // Redraw the scene without ghost ball or vertical line
    }

    // Initialize game
    newQuestion(); // Call newQuestion to initialize the slider correctly

    // Event listeners
    document.getElementById('overlapSlider').addEventListener('input', (event) => {
      updateOverlapDisplay(event.target.value);
    });

    document.getElementById('confirmButton').addEventListener('click', () => {
      const userChoice = parseInt(document.getElementById('overlapSlider').value, 10);
      checkAnswer(userChoice);
    });

    document.getElementById('newButton').addEventListener('click', newQuestion);
  </script>
</body>
</html>



